name: Build Installer

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyqt5 pyinstaller pillow
      
      - name: Convert PNG to ICO
        run: |
          python -c "
          from PIL import Image
          img = Image.open('assets/icon.png')
          img.save('assets/icon.ico', format='ICO', sizes=[(256,256), (128,128), (64,64), (48,48), (32,32), (16,16)])
          print('Icon converted successfully!')
          "
        shell: cmd
      
      - name: Build executable
        run: |
          pyinstaller --onefile --windowed --icon=assets/icon.ico --name=Baiak-Zika --add-data "assets;assets" launcher.py
      
      - name: Prepare installer files
        run: |
          # Copiar Ã­cone para dist
          copy assets\icon.ico dist\
          
          # Criar pasta assets no dist
          mkdir dist\assets
          copy assets\* dist\assets\
        shell: cmd
      
      - name: Create wizard images
        run: |
          python -c "
          from PIL import Image, ImageDraw, ImageFont
          import os
          
          # Imagem grande do wizard (164x314)
          img_large = Image.new('RGB', (164, 314), color=(30, 20, 50))
          draw_large = ImageDraw.Draw(img_large)
          # Gradient effect
          for y in range(314):
              r = int(30 + (y/314) * 30)
              g = int(20 + (y/314) * 10)
              b = int(50 - (y/314) * 20)
              draw_large.line([(0, y), (164, y)], fill=(r, g, b))
          # Text
          draw_large.text((20, 130), 'BAIAK', fill='#ff4444', font=None)
          draw_large.text((20, 160), 'ZIKA', fill='#ffd700', font=None)
          img_large.save('installer/wizard_image.bmp', 'BMP')
          
          # Imagem pequena do wizard (55x58)
          img_small = Image.new('RGB', (55, 58), color=(40, 25, 60))
          img_small.save('installer/wizard_small.bmp', 'BMP')
          
          print('Wizard images created!')
          "
        shell: cmd
      
      - name: Install Inno Setup
        run: |
          choco install innosetup -y
        shell: cmd
      
      - name: Build Installer
        run: |
          cd installer
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup.iss
        shell: powershell
      
      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: Baiak-Zika-Installer
          path: installer/Output/Baiak-Zika-Setup.exe
          retention-days: 30
      
      - name: Upload Portable (ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: Baiak-Zika-Portable
          path: |
            dist/Baiak-Zika.exe
            dist/icon.ico
            dist/assets/
          retention-days: 30
